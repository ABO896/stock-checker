<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Stock Checker</title>
                <link rel="preconnect" href="https://fonts.gstatic.com" />
                <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
                <link rel="stylesheet" href="/static/styles.css" />
	</head>
        <body>
                <div class="container">
                <h1>Stock Checker</h1>
                <div id="market-status" class="sidebar">
                        <h3>Market Status</h3>
                        <p id="market-info">Loading...</p>
                </div>
		<form id="stock-form">
			<label for="symbol">Enter Stock Symbol:</label>
                        <input
                                type="text"
                                id="symbol"
                                name="symbol"
                                list="suggestions"
                                required
                                autocomplete="off"
                        />
                        <datalist id="suggestions"></datalist>
			<button type="submit">Search</button>
		</form>
		<div id="loading"></div>
		<div id="result">
			<h2 id="stock-name"></h2>
			<p id="current-price"></p>
			<p id="change"></p>
		</div>
                <div id="peers" style="display: none">
                        <h3>Related Companies</h3>
                        <ul id="peers-list"></ul>
                </div>
                <div id="financials" style="display: none">
                        <h3>Basic Financials</h3>
                        <ul id="financials-list"></ul>
                </div>
                <div class="error" id="error-message"></div>
		<script>
			const form = document.getElementById('stock-form');
                        const resultDiv = document.getElementById('result');
        const peersDiv = document.getElementById('peers');
        const peersList = document.getElementById('peers-list');
        const financialsDiv = document.getElementById('financials');
        const financialsList = document.getElementById('financials-list');
        const marketInfo = document.getElementById('market-info');
        const stockName = document.getElementById('stock-name');
                        const currentPrice = document.getElementById('current-price');
                        const change = document.getElementById('change');
                        const loadingSpinner = document.getElementById('loading');
                        const errorMessage = document.getElementById('error-message');
        const suggestions = document.getElementById('suggestions');
        const symbolInput = document.getElementById('symbol');

        async function fetchMarketStatus() {
                try {
                        const resp = await fetch('/market-status');
                        if (!resp.ok) {
                                marketInfo.textContent = 'Status unavailable';
                                return;
                        }
                        const data = await resp.json();
                        const status = data.isOpen ? 'Open' : 'Closed';
                        const session = data.session ? ` (${data.session})` : '';
                        marketInfo.textContent = `${data.exchange} market is ${status}${session}`;
                } catch (e) {
                        marketInfo.textContent = 'Status unavailable';
                }
        }

        window.addEventListener('load', fetchMarketStatus);

			async function fetchStockData(symbol) {
				try {
                                        const response = await fetch(`/stock?symbol=${encodeURIComponent(symbol)}`);
					if (!response.ok) {
						if (response.status === 404) {
							throw new Error(
								'Stock data not found. Please check the symbol and try again.'
							);
						} else {
							throw new Error(
								'An error occurred while fetching stock data. Please try again later.'
							);
						}
					}
					return await response.json();
				} catch (error) {
					throw error;
				}
			}

			function displayError(message) {
				errorMessage.textContent = message;
				setTimeout(() => {
					errorMessage.textContent = '';
				}, 5000);
			}

        function clearPreviousResults() {
                stockName.textContent = '';
                currentPrice.textContent = '';
                change.textContent = '';
                peersList.innerHTML = '';
                financialsList.innerHTML = '';
                errorMessage.textContent = '';
                resultDiv.style.display = 'none';
                peersDiv.style.display = 'none';
                financialsDiv.style.display = 'none';
        }

                        async function fetchSuggestions(query) {
                                try {
                                        const resp = await fetch(`/search?query=${encodeURIComponent(query)}`);
                                        if (!resp.ok) {
                                                return [];
                                        }
                                        const data = await resp.json();
                                        return data.results || [];
                                } catch (err) {
                                        console.error('Error fetching suggestions:', err);
                                        return [];
                                }
                        }

                        let suggestionTimeout;
                        symbolInput.addEventListener('input', async (e) => {
                                const val = e.target.value.trim();
                                clearTimeout(suggestionTimeout);
                                if (val.length < 2) {
                                        suggestions.innerHTML = '';
                                        return;
                                }
                                suggestionTimeout = setTimeout(async () => {
                                        const results = await fetchSuggestions(val);
                                        suggestions.innerHTML = results
                                                .map(
                                                        (r) =>
                                                                `<option value="${r.symbol}">${r.description} (${r.symbol})</option>`
                                                )
                                                .join('');
                                }, 300);
                        });

			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				const symbol = document.getElementById('symbol').value.trim();

                                // console.log(`Search submitted for symbol: ${symbol}`);

				clearPreviousResults();
				loadingSpinner.style.display = 'block';

				try {
					const data = await fetchStockData(symbol);
                                        // console.log('Response data received:', data);

					// Display stock name and current price
					stockName.textContent = `${data.company_name || symbol} (${symbol})`;
					currentPrice.textContent = `Current Price: $${data.current_price}`;
					change.textContent = `Change: $${data.change} (${data.percent_change}%)`;
					resultDiv.style.display = 'block';

                                        // Display peers data
                                        if (
                                                data.peers &&
                                                Array.isArray(data.peers) &&
                                                data.peers.length > 0
                                        ) {
                                                const peersHtml = data.peers
                                                        .map(
                                                                (peer) =>
                                                                        `<li><button type="button" class="peer-button" data-symbol="${peer}">${peer}</button></li>`
                                                        )
                                                        .join('');
                                                peersList.innerHTML = peersHtml;
                                                peersDiv.style.display = 'block';
                                        } else {
                                                peersList.innerHTML = '<li>No related companies available.</li>';
                                                peersDiv.style.display = 'block';
                                        }

                                        // Display basic financials
                                        if (data.financials) {
                                                const entries = Object.entries(data.financials).filter(([,v]) => v !== null && v !== undefined);
                                                const finHtml = entries
                                                        .map(([k,v]) => `<li>${k}: ${v}</li>`)
                                                        .join('');
                                                financialsList.innerHTML = finHtml || '<li>No data</li>';
                                                financialsDiv.style.display = 'block';
                                        }
                                } catch (error) {
                                        console.error('Error fetching stock data:', error);
                                        displayError(error.message);
                                } finally {
                                        loadingSpinner.style.display = 'none';
                                }
                        });

                        peersList.addEventListener('click', (event) => {
                                const button = event.target.closest('.peer-button');
                                if (button) {
                                        const sym = button.getAttribute('data-symbol');
                                        symbolInput.value = sym;
                                        form.dispatchEvent(new Event('submit'));
                                }
                        });
                </script>
                </div>
        </body>
</html>
